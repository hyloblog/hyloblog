{{ template "header" . }}

<div id="toast" class="toast"></div>

<div id="demoSiteSection">
	<h6>Preview your demo blog</h6>
	<p>Click the button below to generate a demo site based on your Git repository.</p>
	<button id="previewDemoBtn">Preview Demo Site</button>
	<div id="demoSiteMessage" style="margin-top: 10px;"></div>
</div>

<div>
	<h6>View blog metrics</h6>
	<p>Click here to navigate to your blog metrics</p>
	<a href="dashboard">metrics</a>
</div>

<div>
	<h6>Configure subdomain and launch</h6>
	<!-- need these as templates so that multiple blogs can be setup at once -->
	<form id="subdomainForm" class="subdomain-checker" onsubmit="return false;">
		<label for="subdomainInput">Choose your subdomain:</label>
		<input type="text" id="subdomainInput" placeholder="Enter your subdomain" required />
		<div id="availabilityMessage" class="availability-message"></div>
		<button type="submit" id="submitBtn" disabled>Launch 🚀</button>
	</form>
</div>

<div class="subscription-plans">
	<h6>Select a Subscription Plan</h6>
	{{ range .Data.Plans }}
		{{ template "subscription_product" . }}
	{{ end }}
</div>

<script>
	let debounceTimer;

	/* initialize event listeners */
	function init() {
		const subdomainInput = document.getElementById("subdomainInput");
		const subdomainForm = document.getElementById("subdomainForm");
		const previewDemoBtn = document.getElementById("previewDemoBtn")

		subdomainInput.addEventListener("input", handleInput);
		subdomainForm.addEventListener("submit", handleFormSubmit);
		previewDemoBtn.addEventListener("click", generateDemoSite);
	}

	/* handle input event with debounce */
	function handleInput() {
		const subdomain = this.value.trim();
		const messageElement = document.getElementById("availabilityMessage");
		const submitBtn = document.getElementById("submitBtn");

		clearTimeout(debounceTimer); /* clear previous timer */

		if (subdomain.length > 0) {
			updateMessage(messageElement, "Checking availability...", "loading");
		} else {
			resetMessage(messageElement, submitBtn); /* Clear message if input is empty */
			return;
		}

		debounceTimer = setTimeout(() => {
			checkSubdomainAvailability(subdomain, messageElement, submitBtn);
		}, 300); /* 300ms debounce delay */
	}

	/* Check subdomain availability */
	function checkSubdomainAvailability(subdomain, messageElement, submitBtn) {
		fetch("subdomain/check", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ subdomain })
		})
		.then(response => response.json())
		.then(data => {
			if (data.available) {
				updateMessage(messageElement, "✅ This subdomain is available!", "available");
				submitBtn.disabled = false;
			} else {
				updateMessage(messageElement, "❌ " + data.message, "unavailable");
				submitBtn.disabled = true;
			}
		})
		.catch(error => handleError(error, messageElement, submitBtn));
	}

	/* Handle form submission */
	function handleFormSubmit(event) {
		event.preventDefault(); /* Prevent default form submission */

		const subdomain = document.getElementById("subdomainInput").value.trim();
		submitSubdomain(subdomain);
	}

	/* Submit the subdomain to the server */
	function submitSubdomain(subdomain) {
		fetch("subdomain/submit", {
			method: "POST",
			headers: { "Content-Type": "application/json" },
			body: JSON.stringify({ subdomain })
		})
		.then(response => {
			if (!response.ok) {
				return response.json().then(errorData => {
					showToast(errorData.message);
					throw new Error(errorData.message);
				});
			}
			return response.json();
		})
		.then(data => {
			console.log("Success: ", data.message);
			showToast("Subdomain successfully registered!");
		})
		.catch(error => console.error("Error submitting subdomain:", error));
	}

	/* Update the availability message */
	function updateMessage(element, message, status) {
		element.textContent = message;
		element.className = `availability-message ${status}`;
	}

	/* Reset the message and disable submit button */
	function resetMessage(messageElement, submitBtn) {
		messageElement.textContent = ''; /* Clear message */
		submitBtn.disabled = true; /* Disable submit button */
	}

	/* Handle fetch errors */
	function handleError(error, messageElement, submitBtn) {
		console.error('Error checking subdomain:', error);
		updateMessage(messageElement, "⚠️ An error occurred while checking availability.", "unavailable");
		submitBtn.disabled = true; /* Disable submit button on error */
	}

	/* Generate the demo site */
	function generateDemoSite() {
		const messageElement = document.getElementById('demoSiteMessage');
		showToast("Generating demo site, please wait...");

		fetch("generate-demo", {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
			},
		})
		.then(response => {
			if (!response.ok) {
				throw new Error('Failed to generate demo site');
			}
			return response.json();
		})
		.then(data => {
			/* Redirect to the demo site or show a link */
			console.log(`redirecting to ${data.demo_site_url}`)
			window.open(data.demo_site_url, '_blank');
			showToast("Demo site generated successfully!");
		})
		.catch(error => {
			console.error('Error generating demo site:', error);
			showToast("Error generating demo site. Please try again.");
		});
	}

	/* Show a toast message */
	function showToast(message) {
		const toast = document.getElementById('toast');
		toast.textContent = message;
		toast.style.display = 'block';

		setTimeout(() => {
			toast.style.display = 'none';
		}, 3000); // Hide after 3 seconds
	}

	/* Initialize the script on page load */
	document.addEventListener('DOMContentLoaded', init);
</script>

{{ template "footer". }}
